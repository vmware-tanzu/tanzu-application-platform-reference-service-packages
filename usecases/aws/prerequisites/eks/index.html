<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to create an EKS cluster with EBS CSI driver"><link href=https://vmware-tanzu.github.io/tanzu-application-platform-reference-service-packages/usecases/aws/prerequisites/eks/ rel=canonical><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-8.5.10"><title>Create an EKS cluster with EBS CSI driver - Tanzu Application Platform Reference Service Packages</title><link rel=stylesheet href=../../../../assets/stylesheets/main.472b142f.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.08040f6c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Metropolis,Avenir+Next,Helvetica+Neue,Arial,sans-serif:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Metropolis,Avenir Next,Helvetica Neue,Arial,sans-serif";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../../assets/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#define-the-environment-parameters class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title="Tanzu Application Platform Reference Service Packages" class="md-header__button md-logo" aria-label="Tanzu Application Platform Reference Service Packages" data-md-component=logo> <img src=../../../../assets/vm-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tanzu Application Platform Reference Service Packages </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Create an EKS cluster with EBS CSI driver </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/vmware-tanzu/tanzu-application-platform-reference-service-packages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> vmware-tanzu/tanzu-application-platform-reference-service-packages </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> HOME </a> </li> <li class=md-tabs__item> <a href=../../packages/elasticache/ack/ class="md-tabs__link md-tabs__link--active"> Use cases </a> </li> <li class=md-tabs__item> <a href=../../../../crossplane/ class=md-tabs__link> Crossplane </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Tanzu Application Platform Reference Service Packages" class="md-nav__button md-logo" aria-label="Tanzu Application Platform Reference Service Packages" data-md-component=logo> <img src=../../../../assets/vm-logo.png alt=logo> </a> Tanzu Application Platform Reference Service Packages </label> <div class=md-nav__source> <a href=https://github.com/vmware-tanzu/tanzu-application-platform-reference-service-packages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> vmware-tanzu/tanzu-application-platform-reference-service-packages </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> HOME </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Use cases <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Use cases" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Use cases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1> AWS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=AWS data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_1 type=checkbox id=__nav_2_1_1> <label class=md-nav__link for=__nav_2_1_1> Packages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Packages data-md-level=3> <label class=md-nav__title for=__nav_2_1_1> <span class="md-nav__icon md-icon"></span> Packages </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_1_1 type=checkbox id=__nav_2_1_1_1> <label class=md-nav__link for=__nav_2_1_1_1> Elasticache with ACK <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Elasticache with ACK" data-md-level=4> <label class=md-nav__title for=__nav_2_1_1_1> <span class="md-nav__icon md-icon"></span> Elasticache with ACK </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../packages/elasticache/ack/ class=md-nav__link> Consuming AWS Elasticache with ACK </a> </li> <li class=md-nav__item> <a href=../../packages/elasticache/ack/manual/ class=md-nav__link> Creating AWS Elasticache Instances manually using kubectl (experimental) </a> </li> <li class=md-nav__item> <a href=../../packages/elasticache/ack/package/ class=md-nav__link> Creating AWS Elasticache instances by using a Carvel package (experimental) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_2 type=checkbox id=__nav_2_1_2 checked> <label class=md-nav__link for=__nav_2_1_2> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Prerequisites data-md-level=3> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> AWS prerequisites </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Create an EKS cluster with EBS CSI driver <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Create an EKS cluster with EBS CSI driver </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#define-the-environment-parameters class=md-nav__link> Define the environment parameters </a> </li> <li class=md-nav__item> <a href=#create-the-eks-cluster class=md-nav__link> Create the EKS cluster </a> </li> <li class=md-nav__item> <a href=#configure-the-ebs-csi-controller class=md-nav__link> Configure the EBS CSI controller </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ack/ class=md-nav__link> Install the AWS Controllers for Kubernetes (ACK) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Azure <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Azure data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Azure </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_1 type=checkbox id=__nav_2_2_1> <label class=md-nav__link for=__nav_2_2_1> Packages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Packages data-md-level=3> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> Packages </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_1_1 type=checkbox id=__nav_2_2_1_1> <label class=md-nav__link for=__nav_2_2_1_1> MongoDB with Crossplane <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="MongoDB with Crossplane" data-md-level=4> <label class=md-nav__title for=__nav_2_2_1_1> <span class="md-nav__icon md-icon"></span> MongoDB with Crossplane </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../azure/packages/mongodb/crossplane/ class=md-nav__link> Consume MongoDB via Crossplane </a> </li> <li class=md-nav__item> <a href=../../../azure/packages/mongodb/crossplane/consume-instance/ class=md-nav__link> Via Crossplane Instances </a> </li> <li class=md-nav__item> <a href=../../../azure/packages/mongodb/crossplane/consume-package/ class=md-nav__link> Via Crossplane Package </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_2 type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Prerequisites data-md-level=3> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../azure/prerequisites/ class=md-nav__link> Azure Packages Prerequisites </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Crossplane <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Crossplane data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Crossplane </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../crossplane/ class=md-nav__link> Install Crossplane </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2> Providers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Providers data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Providers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../crossplane/providers/aws/ class=md-nav__link> UXP AWS provider </a> </li> <li class=md-nav__item> <a href=../../../../crossplane/providers/azure/ class=md-nav__link> UXP Azure provider </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#define-the-environment-parameters class=md-nav__link> Define the environment parameters </a> </li> <li class=md-nav__item> <a href=#create-the-eks-cluster class=md-nav__link> Create the EKS cluster </a> </li> <li class=md-nav__item> <a href=#configure-the-ebs-csi-controller class=md-nav__link> Configure the EBS CSI controller </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Create an EKS cluster with EBS CSI driver</h1> <p>An EKS cluster can be created in a number of ways, including AWS console, CLI, Terraform or CloudFormation. The quickest and simplest way to create an EKS cluster is to use <a href=https://eksctl.io/ >eksctl</a>, a CloudFormation wrapper, that will be used in this guide.</p> <h2 id=define-the-environment-parameters>Define the environment parameters<a class=headerlink href=#define-the-environment-parameters title="Permanent link">&para;</a></h2> <p>The following are the parameters needed for the commands in this guide, which must be set the values that match your environment and needs.</p> <div class=highlight><pre><span></span><code><span class=c1># AWS region you&#39;re operating in</span>
<span class=nb>export</span> <span class=nv>AWS_REGION</span><span class=o>=</span><span class=s2>&quot;eu-central-1&quot;</span>

<span class=c1># autoscaling group minimum number of nodes</span>
<span class=nv>ASG_MIN_NODES</span><span class=o>=</span><span class=s2>&quot;2&quot;</span>

<span class=c1># autoscaling group maximum number of nodes</span>
<span class=nv>ASG_MAX_NODES</span><span class=o>=</span><span class=s2>&quot;4&quot;</span>

<span class=c1># EKS cluster name</span>
<span class=nv>CLUSTER_NAME</span><span class=o>=</span><span class=s2>&quot;my-eks-cluster&quot;</span>

<span class=c1># EKS kubernetes version to deploy</span>
<span class=nv>KUBERNETES_VERSION</span><span class=o>=</span><span class=s2>&quot;1.23&quot;</span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The <code>AWS_REGION</code> variable must be an environment variable (thus the <code>export</code>) to be used by <code>eksctl</code> and <code>aws</code> commands. The other variables can be just shell variables.</p> </div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>A list of available kubernetes versions for the <code>KUBERNETES_VERSION</code> variable can be obtained running</p> <div class=highlight><pre><span></span><code>aws eks describe-addon-versions --query <span class=s2>&quot;addons[].addonVersions[].compatibilities[].clusterVersion&quot;</span> <span class=p>|</span> jq <span class=s1>&#39;unique|sort&#39;</span>
</code></pre></div> </div> <h2 id=create-the-eks-cluster>Create the EKS cluster<a class=headerlink href=#create-the-eks-cluster title="Permanent link">&para;</a></h2> <p>The following command can create an EKS cluster based on the parameters defined above:</p> <div class=highlight><pre><span></span><code>eksctl create cluster -m <span class=si>${</span><span class=nv>ASG_MIN_NODES</span><span class=si>}</span> -M <span class=si>${</span><span class=nv>ASG_MAX_NODES</span><span class=si>}</span> -n <span class=si>${</span><span class=nv>CLUSTER_NAME</span><span class=si>}</span> --version <span class=si>${</span><span class=nv>KUBERNETES_VERSION</span><span class=si>}</span>
</code></pre></div> <p>The previous command waits until the cluster is created and also updates the <code>KUBECONFIG</code> file with the details of the new cluster.</p> <h2 id=configure-the-ebs-csi-controller>Configure the EBS CSI controller<a class=headerlink href=#configure-the-ebs-csi-controller title="Permanent link">&para;</a></h2> <p>From version 1.23 onwards it is necessary to create the addon for the EBS CSI driver.</p> <div class=highlight><pre><span></span><code>aws eks create-addon --cluster-name <span class=si>${</span><span class=nv>CLUSTER_NAME</span><span class=si>}</span> --addon-name aws-ebs-csi-driver
</code></pre></div> <p>EKS pods' service accounts can assume AWS IAM roles to be able to authenticate and interact with the AWS APIs. They are mapped to web identities via an IAM OIDC provider that must be created for the EKS cluster. You will then need to create a proper role for the EBS CSI controller to be able to create and manage EBS volumes.</p> <div class=highlight><pre><span></span><code><span class=c1># define variables for IAM</span>
<span class=nv>ACCOUNT_ID</span><span class=o>=</span><span class=k>$(</span>aws sts get-caller-identity --query Account --output text<span class=k>)</span>
<span class=nv>OIDC_ID</span><span class=o>=</span><span class=k>$(</span>aws eks describe-cluster --name <span class=si>${</span><span class=nv>CLUSTER_NAME</span><span class=si>}</span> --output text --query <span class=s2>&quot;cluster.identity.oidc.issuer&quot;</span> <span class=p>|</span> cut -d/ -f3-<span class=k>)</span>
<span class=nv>EBS_ROLE</span><span class=o>=</span>AmazonEKS_EBS_CSI_Driver-<span class=si>${</span><span class=nv>CLUSTER_NAME</span><span class=si>}</span>
<span class=nv>ROLE_TRUST_POLICY</span><span class=o>=</span><span class=k>$(</span>mktemp<span class=k>)</span>
<span class=nv>ROLE_PERMISSION_POLICY</span><span class=o>=</span><span class=k>$(</span>mktemp<span class=k>)</span>

<span class=c1># prepare the trust policy document</span>
cat &gt; <span class=si>${</span><span class=nv>ROLE_TRUST_POLICY</span><span class=si>}</span> <span class=s>&lt;&lt;EOF</span>
<span class=s>{</span>
<span class=s>    &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class=s>    &quot;Statement&quot;: [{</span>
<span class=s>        &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class=s>        &quot;Principal&quot;: {</span>
<span class=s>            &quot;Federated&quot;: &quot;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/${OIDC_ID}&quot;</span>
<span class=s>        },</span>
<span class=s>        &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span>
<span class=s>        &quot;Condition&quot;: {</span>
<span class=s>            &quot;StringEquals&quot;: {</span>
<span class=s>                &quot;${OIDC_ID}:sub&quot;: &quot;system:serviceaccount:kube-system:ebs-csi-controller-sa&quot;</span>
<span class=s>            }</span>
<span class=s>        }</span>
<span class=s>    }]</span>
<span class=s>}</span>
<span class=s>EOF</span>

<span class=c1># create the role for the EBS CSI controller with the proper trust policy</span>
aws iam create-role --role-name <span class=si>${</span><span class=nv>EBS_ROLE</span><span class=si>}</span> --assume-role-policy-document file://<span class=si>${</span><span class=nv>ROLE_TRUST_POLICY</span><span class=si>}</span>

<span class=c1># fetch a sample permission policy document</span>
curl -sSfL -o <span class=si>${</span><span class=nv>ROLE_PERMISSION_POLICY</span><span class=si>}</span> https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/docs/example-iam-policy.json

<span class=c1># create the permission policy</span>
<span class=nv>PERMISSION_POLICY_ARN</span><span class=o>=</span><span class=k>$(</span>aws iam create-policy --policy-name <span class=si>${</span><span class=nv>EBS_ROLE</span><span class=si>}</span> --policy-document file://<span class=si>${</span><span class=nv>ROLE_PERMISSION_POLICY</span><span class=si>}</span> --query Policy.Arn --output text<span class=k>)</span>

<span class=c1># attach the policy to the role</span>
aws iam attach-role-policy --policy-arn <span class=si>${</span><span class=nv>PERMISSION_POLICY_ARN</span><span class=si>}</span> --role-name <span class=si>${</span><span class=nv>EBS_ROLE</span><span class=si>}</span>

<span class=c1># clean up temporary files</span>
rm <span class=si>${</span><span class=nv>ROLE_TRUST_POLICY</span><span class=si>}</span>
rm <span class=si>${</span><span class=nv>ROLE_PERMISSION_POLICY</span><span class=si>}</span>
</code></pre></div> <p>Next, you must prepare the OIDC provider (see also <a href=https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html>AWS documentation</a>). If the EKS cluster has just been created the OIDC provider does not exist yet, otherwise you can run the following command to make sure</p> <div class=highlight><pre><span></span><code>aws iam list-open-id-connect-providers <span class=p>|</span> grep <span class=nv>$OIDC_ID</span>
</code></pre></div> <p>If no output is returned, the OIDC provider does not exist and you must create it.</p> <div class="admonition note"> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Option 1 (quick)</label><label for=__tabbed_1_2>Option 2 (know what you are doing)</label></div> <div class=tabbed-content> <div class=tabbed-block> <p>The <code>eksctl</code> does the heavy lifting for you and creates the OIDC provider with the proper configuration for your EKS cluster.</p> <div class=highlight><pre><span></span><code>eksctl utils associate-iam-oidc-provider --cluster <span class=si>${</span><span class=nv>CLUSTER_NAME</span><span class=si>}</span> --approve
</code></pre></div> </div> <div class=tabbed-block> <p>Get rid of the <code>eksctl</code> magic and configure the OIDC provider yourself.</p> <p>Get the SHA1 fingerprint for validating the OIDC provider certificate: <div class=highlight><pre><span></span><code><span class=nv>OIDC_HOST</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$OIDC_ID</span> <span class=p>|</span> cut -d/ -f1<span class=k>)</span>
<span class=nv>SHA1_FINGERPRINT</span><span class=o>=</span><span class=k>$(</span><span class=o>{</span><span class=nb>echo</span> <span class=p>|</span> openssl s_client -connect <span class=si>${</span><span class=nv>OIDC_HOST</span><span class=si>}</span>:443 -servername <span class=si>${</span><span class=nv>OIDC_HOST</span><span class=si>}</span> -showcerts <span class=p>|</span> openssl x509 -fingerprint -noout -sha1<span class=o>}</span> <span class=m>2</span>&gt;/dev/null <span class=p>|</span> cut -d<span class=o>=</span> -f2 <span class=p>|</span> sed s/://g<span class=k>)</span>
</code></pre></div></p> <p>Create the OIDC provider: <div class=highlight><pre><span></span><code>aws iam create-open-id-connect-provider --url <span class=si>${</span><span class=nv>OIDC_URL</span><span class=si>}</span> --thumbprint-list <span class=si>${</span><span class=nv>SHA1_FINGERPRINT</span><span class=si>}</span> --client-id-list sts.amazonaws.com
</code></pre></div></p> </div> </div> </div> </div> <p>You must then configure the Kubernetes service account to assume the role</p> <div class=highlight><pre><span></span><code><span class=c1># annotate the controller service account with the new role ARN</span>
kubectl -n kube-system annotate serviceaccount ebs-csi-controller-sa eks.amazonaws.com/role-arn<span class=o>=</span>arn:aws:iam::<span class=si>${</span><span class=nv>ACCOUNT_ID</span><span class=si>}</span>:role/<span class=si>${</span><span class=nv>EBS_ROLE</span><span class=si>}</span>

<span class=c1># restart ebs-csi-controller pods</span>
kubectl -n kube-system rollout restart deployment ebs-csi-controller
</code></pre></div> <p>Your EKS cluster is now configured to dynamically allocate EBS volumes. You need to create the proper <code>StorageClass</code> resources for your <code>PersistentVolumeClaims</code> to use, like in <a href=https://github.com/kubernetes-sigs/aws-ebs-csi-driver/tree/master/examples/kubernetes/dynamic-provisioning>this example</a>.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2022-11-05 01:08:19</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ class="md-footer__link md-footer__link--prev" aria-label="Previous: AWS prerequisites" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> AWS prerequisites </div> </div> </a> <a href=../ack/ class="md-footer__link md-footer__link--next" aria-label="Next: Install the AWS Controllers for Kubernetes (ACK)" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Install the AWS Controllers for Kubernetes (ACK) </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 VMware </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"method": "mike", "provider": "mike"}}</script> <script src=../../../../assets/javascripts/bundle.d6c3db9e.min.js></script> </body> </html>