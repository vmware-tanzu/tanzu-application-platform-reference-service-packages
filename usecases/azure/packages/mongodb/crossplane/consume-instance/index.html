<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to create an Azure MongoDB instance via Crossplane"><link href=https://vmware-tanzu.github.io/tanzu-application-platform-reference-service-packages/usecases/azure/packages/mongodb/crossplane/consume-instance/ rel=canonical><link href=../ rel=prev><link href=../consume-package/ rel=next><link rel=icon href=../../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.11"><title>Via Crossplane Instances - Tanzu Application Platform Reference Service Packages</title><link rel=stylesheet href=../../../../../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../../../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Metropolis,Avenir+Next,Helvetica+Neue,Arial,sans-serif:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Metropolis,Avenir Next,Helvetica Neue,Arial,sans-serif";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../../../../assets/extra.css><script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pre-requisites class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../../.. title="Tanzu Application Platform Reference Service Packages" class="md-header__button md-logo" aria-label="Tanzu Application Platform Reference Service Packages" data-md-component=logo> <img src=../../../../../../assets/vm-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tanzu Application Platform Reference Service Packages </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Via Crossplane Instances </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/vmware-tanzu/tanzu-application-platform-reference-service-packages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> vmware-tanzu/tanzu-application-platform-reference-service-packages </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../../.. class=md-tabs__link> HOME </a> </li> <li class=md-tabs__item> <a href=../../../../../aws/packages/elasticache/ack/ class="md-tabs__link md-tabs__link--active"> Use cases </a> </li> <li class=md-tabs__item> <a href=../../../../../../crossplane/ class=md-tabs__link> Crossplane </a> </li> <li class=md-tabs__item> <a href=../../../../../../ci/ class=md-tabs__link> CI </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../../.. title="Tanzu Application Platform Reference Service Packages" class="md-nav__button md-logo" aria-label="Tanzu Application Platform Reference Service Packages" data-md-component=logo> <img src=../../../../../../assets/vm-logo.png alt=logo> </a> Tanzu Application Platform Reference Service Packages </label> <div class=md-nav__source> <a href=https://github.com/vmware-tanzu/tanzu-application-platform-reference-service-packages title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> vmware-tanzu/tanzu-application-platform-reference-service-packages </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../.. class=md-nav__link> HOME </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Use cases <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Use cases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> AWS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_1> <label class=md-nav__link for=__nav_2_1_1 id=__nav_2_1_1_label tabindex=0> Packages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_1> <span class="md-nav__icon md-icon"></span> Packages </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_1_1> <label class=md-nav__link for=__nav_2_1_1_1 id=__nav_2_1_1_1_label tabindex=0> Elasticache with ACK <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_1_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_1_1> <span class="md-nav__icon md-icon"></span> Elasticache with ACK </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../aws/packages/elasticache/ack/ class=md-nav__link> Consuming AWS Elasticache with ACK </a> </li> <li class=md-nav__item> <a href=../../../../../aws/packages/elasticache/ack/manual/ class=md-nav__link> Creating AWS Elasticache Instances manually using kubectl (experimental) </a> </li> <li class=md-nav__item> <a href=../../../../../aws/packages/elasticache/ack/package/ class=md-nav__link> Creating AWS Elasticache instances by using a Carvel package (experimental) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_2> <label class=md-nav__link for=__nav_2_1_2 id=__nav_2_1_2_label tabindex=0> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../aws/prerequisites/ class=md-nav__link> AWS prerequisites </a> </li> <li class=md-nav__item> <a href=../../../../../aws/prerequisites/eks/ class=md-nav__link> Create an EKS cluster with EBS CSI driver </a> </li> <li class=md-nav__item> <a href=../../../../../aws/prerequisites/ack/ class=md-nav__link> Install the AWS Controllers for Kubernetes (ACK) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> Azure <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Azure </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1 checked> <label class=md-nav__link for=__nav_2_2_1 id=__nav_2_2_1_label tabindex=0> Packages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> Packages </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_1 checked> <label class=md-nav__link for=__nav_2_2_1_1 id=__nav_2_2_1_1_label tabindex=0> MongoDB with Crossplane <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_1_1> <span class="md-nav__icon md-icon"></span> MongoDB with Crossplane </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Consume MongoDB via Crossplane </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Via Crossplane Instances <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Via Crossplane Instances </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> <nav class=md-nav aria-label=Pre-requisites> <ul class=md-nav__list> <li class=md-nav__item> <a href=#verify-provider class=md-nav__link> Verify Provider </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-namespace class=md-nav__link> Create Namespace </a> </li> <li class=md-nav__item> <a href=#create-resource-group class=md-nav__link> Create Resource Group </a> </li> <li class=md-nav__item> <a href=#create-cosmosdb-account class=md-nav__link> Create CosmosDB Account </a> </li> <li class=md-nav__item> <a href=#create-mongo-database class=md-nav__link> Create Mongo Database </a> </li> <li class=md-nav__item> <a href=#create-mongo-collection class=md-nav__link> Create Mongo Collection </a> </li> <li class=md-nav__item> <a href=#verify-managed-resource-creation class=md-nav__link> Verify Managed Resource Creation </a> </li> <li class=md-nav__item> <a href=#create-a-connection-details-secret class=md-nav__link> Create a connection details secret </a> <nav class=md-nav aria-label="Create a connection details secret"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#secretgen-rbac-permissions class=md-nav__link> SecretGen RBAC permissions </a> </li> <li class=md-nav__item> <a href=#secret-template class=md-nav__link> Secret Template </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#resourceclaim-policy-optional class=md-nav__link> ResourceClaim Policy (optional) </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> Next Steps </a> </li> <li class=md-nav__item> <a href=#cleanup class=md-nav__link> Cleanup </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../consume-package/ class=md-nav__link> Via Crossplane Package </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../prerequisites/ class=md-nav__link> Azure Packages Prerequisites </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> Multicloud <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Multicloud </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1> <label class=md-nav__link for=__nav_2_3_1 id=__nav_2_3_1_label tabindex=0> Packages <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1> <span class="md-nav__icon md-icon"></span> Packages </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_1> <label class=md-nav__link for=__nav_2_3_1_1 id=__nav_2_3_1_1_label tabindex=0> Postgresql with Crossplane <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_1> <span class="md-nav__icon md-icon"></span> Postgresql with Crossplane </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../multicloud/packages/psql/ class=md-nav__link> Consuming Postgresql Multicloud </a> </li> <li class=md-nav__item> <a href=../../../../../multicloud/packages/psql/create/ class=md-nav__link> Creating the Postgresql Multicloud Crossplane package </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Crossplane <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Crossplane </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../crossplane/ class=md-nav__link> Install Crossplane </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> Providers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Providers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../crossplane/providers/aws/ class=md-nav__link> UXP AWS provider </a> </li> <li class=md-nav__item> <a href=../../../../../../crossplane/providers/azure/ class=md-nav__link> UXP Azure provider </a> </li> <li class=md-nav__item> <a href=../../../../../../crossplane/providers/terraform/ class=md-nav__link> UXP Terraform provider </a> </li> <li class=md-nav__item> <a href=../../../../../../crossplane/providers/helm/ class=md-nav__link> Helm provider </a> </li> <li class=md-nav__item> <a href=../../../../../../crossplane/providers/kubernetes/ class=md-nav__link> Kubernetes provider </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> CI <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> CI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../ci/ class=md-nav__link> Continuous Integration </a> </li> <li class=md-nav__item> <a href=../../../../../../ci/documentation/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../../../../../../ci/carvel-crossplane-packages/ class=md-nav__link> Carvel and Crossplane packages </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> <nav class=md-nav aria-label=Pre-requisites> <ul class=md-nav__list> <li class=md-nav__item> <a href=#verify-provider class=md-nav__link> Verify Provider </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-namespace class=md-nav__link> Create Namespace </a> </li> <li class=md-nav__item> <a href=#create-resource-group class=md-nav__link> Create Resource Group </a> </li> <li class=md-nav__item> <a href=#create-cosmosdb-account class=md-nav__link> Create CosmosDB Account </a> </li> <li class=md-nav__item> <a href=#create-mongo-database class=md-nav__link> Create Mongo Database </a> </li> <li class=md-nav__item> <a href=#create-mongo-collection class=md-nav__link> Create Mongo Collection </a> </li> <li class=md-nav__item> <a href=#verify-managed-resource-creation class=md-nav__link> Verify Managed Resource Creation </a> </li> <li class=md-nav__item> <a href=#create-a-connection-details-secret class=md-nav__link> Create a connection details secret </a> <nav class=md-nav aria-label="Create a connection details secret"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#secretgen-rbac-permissions class=md-nav__link> SecretGen RBAC permissions </a> </li> <li class=md-nav__item> <a href=#secret-template class=md-nav__link> Secret Template </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#resourceclaim-policy-optional class=md-nav__link> ResourceClaim Policy (optional) </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> Next Steps </a> </li> <li class=md-nav__item> <a href=#cleanup class=md-nav__link> Cleanup </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Via Crossplane Instances</h1> <p>To create a MongoDB instance in Azure, we need the following resources:</p> <ul> <li>ResourceGroup</li> <li>CosmosDB Account</li> <li>MongoDatabase</li> <li>MongoCollection</li> </ul> <p>We will show you how to create all of them with Crossplane's <a href=https://marketplace.upbound.io/providers/upbound/provider-azure/ >official Azure provider</a>.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>We suggest defining a unique name for the resources to avoid potential conflicts. This is because we need the <strong>Resource Group</strong> and the CosmosDB <strong>Account</strong> names to be globally unique (within Azure).</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>UNIQUE_NAME</span><span class=o>=</span>
</code></pre></div> <p>We must set a <strong><em>location</em></strong> where Azure creates the resources. As a default, we use <code>West Europe</code>, but feel free to change this.</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>LOCATION</span><span class=o>=</span><span class=s2>&quot;West Europe&quot;</span>
</code></pre></div> </div> <p>The examples help you create the files with the <code>UNIQUE_NAME</code> and <code>LOCATION</code> values are inserted in the places that matter.</p> <h2 id=pre-requisites>Pre-requisites<a class=headerlink href=#pre-requisites title="Permanent link">&para;</a></h2> <ul> <li><a href=../../../../../../crossplane/ >UpBound's Universal Crossplane</a></li> <li><a href=../../../../../../crossplane/providers/azure/ >Crossplane Azure Provider</a></li> <li><a href=../../../../prerequisites/#secretgen-controller>SecretGen Controller</a>: to transform the secret from Crossplane to the <a href=https://servicebinding.io/ >Service Binding</a> specification</li> </ul> <h3 id=verify-provider>Verify Provider<a class=headerlink href=#verify-provider title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>api-resources<span class=w> </span>--api-group<span class=w> </span>cosmosdb.azure.upbound.io
</code></pre></div> <p>This gives us the following APIs:</p> <div class=highlight><pre><span></span><code>NAME<span class=w>                   </span>SHORTNAMES<span class=w>   </span>APIVERSION<span class=w>                          </span>NAMESPACED<span class=w>   </span>KIND
accounts<span class=w>                            </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>Account
cassandraclusters<span class=w>                   </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>CassandraCluster
cassandradatacenters<span class=w>                </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>CassandraDatacenter
cassandrakeyspaces<span class=w>                  </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>CassandraKeySpace
cassandratables<span class=w>                     </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>CassandraTable
gremlindatabases<span class=w>                    </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>GremlinDatabase
gremlingraphs<span class=w>                       </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>GremlinGraph
mongocollections<span class=w>                    </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>MongoCollection
mongodatabases<span class=w>                      </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>MongoDatabase
sqlcontainers<span class=w>                       </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLContainer
sqldatabases<span class=w>                        </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLDatabase
sqlfunctions<span class=w>                        </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLFunction
sqlroleassignments<span class=w>                  </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLRoleAssignment
sqlroledefinitions<span class=w>                  </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLRoleDefinition
sqlstoredprocedures<span class=w>                 </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLStoredProcedure
sqltriggers<span class=w>                         </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>SQLTrigger
tables<span class=w>                              </span>cosmosdb.azure.upbound.io/v1beta1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>Table
</code></pre></div> <p>We also recommend, especially while testing or doing a PoC, creating a specific <strong>Resource Group</strong> for these resources.</p> <p>The <strong>Resource Group</strong> API is part of the <code>azure.upbound.io</code> API group.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>api-resources<span class=w> </span>--api-group<span class=w> </span>azure.upbound.io
</code></pre></div> <p>As you can see:</p> <div class=highlight><pre><span></span><code>NAME<span class=w>                            </span>SHORTNAMES<span class=w>   </span>APIVERSION<span class=w>                  </span>NAMESPACED<span class=w>   </span>KIND
providerconfigs<span class=w>                              </span>azure.upbound.io/v1beta1<span class=w>    </span><span class=nb>false</span><span class=w>        </span>ProviderConfig
providerconfigusages<span class=w>                         </span>azure.upbound.io/v1beta1<span class=w>    </span><span class=nb>false</span><span class=w>        </span>ProviderConfigUsage
resourcegroups<span class=w>                               </span>azure.upbound.io/v1beta1<span class=w>    </span><span class=nb>false</span><span class=w>        </span>ResourceGroup
resourceproviderregistrations<span class=w>                </span>azure.upbound.io/v1beta1<span class=w>    </span><span class=nb>false</span><span class=w>        </span>ResourceProviderRegistration
storeconfigs<span class=w>                                 </span>azure.upbound.io/v1alpha1<span class=w>   </span><span class=nb>false</span><span class=w>        </span>StoreConfig
subscriptions<span class=w>                                </span>azure.upbound.io/v1beta1<span class=w>    </span><span class=nb>false</span><span class=w>        </span>Subscription
</code></pre></div> <h2 id=create-namespace>Create Namespace<a class=headerlink href=#create-namespace title="Permanent link">&para;</a></h2> <p>There are some places where we need to provide the name of the namespace.</p> <p>For the convenience of this example, we create a namespace with the same name.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>create<span class=w> </span>namespace<span class=w> </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
</code></pre></div> <h2 id=create-resource-group>Create Resource Group<a class=headerlink href=#create-resource-group title="Permanent link">&para;</a></h2> <p>We create a <strong>ResourceGroup</strong> with a unique name and label it. This is because some of the managed resources (i.e., the resources in Azure) depend on other managed resources.</p> <p>To find them, we must instruct Crossplane, which Crossplane resource maps to the dependent managed resource. For this, we use the label.</p> <div class=highlight><span class=filename>resourcegroup.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: azure.upbound.io/v1beta1</span>
<span class=s2>kind: ResourceGroup</span>
<span class=s2>metadata:</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  labels:</span>
<span class=s2>    testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  forProvider:</span>
<span class=s2>    location: </span><span class=si>${</span><span class=nv>LOCATION</span><span class=si>}</span>
<span class=s2>  providerConfigRef:</span>
<span class=s2>    name: default</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>resourcegroup.yml
</code></pre></div> <p>And now, you can apply the file to create the Crossplane resource. Again, the Crossplane controller and the Azure provider controller will ensure the resource in Azure exists and the status is visible on our Crossplane resource in Kubernetes.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>resourcegroup.yml
</code></pre></div> <h2 id=create-cosmosdb-account>Create CosmosDB Account<a class=headerlink href=#create-cosmosdb-account title="Permanent link">&para;</a></h2> <p>Next on the list is the CosmosDB <strong>Account</strong>. This object defines the initial configuration of the <strong>MongoDB</strong> instance.</p> <p>You make this <strong>Account</strong> a <strong>MongoDB</strong> instance by setting the capability <code>EnableMongo</code>. If you want to set a specific version, use the <code>spec.forProvider.mongoServerVersion</code> parameter.</p> <div class=highlight><span class=filename>account.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: cosmosdb.azure.upbound.io/v1beta1</span>
<span class=s2>kind: account</span>
<span class=s2>metadata:</span>
<span class=s2>  annotations:</span>
<span class=s2>    meta.upbound.io/example-id: cosmosdb/v1beta1/mongocollection</span>
<span class=s2>  labels:</span>
<span class=s2>    testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  forProvider:</span>
<span class=s2>    capabilities:</span>
<span class=s2>      - name: EnableMongo</span>
<span class=s2>      - name: mongoEnableDocLevelTTL</span>
<span class=s2>    consistencyPolicy:</span>
<span class=s2>      - consistencyLevel: Strong</span>
<span class=s2>    geoLocation:</span>
<span class=s2>      - failoverPriority: 0</span>
<span class=s2>        location: </span><span class=si>${</span><span class=nv>LOCATION</span><span class=si>}</span>
<span class=s2>    kind: MongoDB</span>
<span class=s2>    location: </span><span class=si>${</span><span class=nv>LOCATION</span><span class=si>}</span>
<span class=s2>    offerType: Standard</span>
<span class=s2>    resourceGroupNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  writeConnectionSecretToRef:</span>
<span class=s2>    namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>    name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>account.yml
</code></pre></div> <p>Create the file and apply it to the cluster.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>account.yml
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The <strong>Account</strong> requires a reference to a <strong>Resource Group</strong>.</p> <p>We do so via the <code>resourceGroupNameSelector</code>:</p> <div class=highlight><pre><span></span><code><span class=nt>resourceGroupNameSelector</span><span class=p>:</span>
<span class=w>  </span><span class=nt>matchLabels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>testing.upbound.io/example-name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${UNIQUE_NAME}</span>
</code></pre></div> </div> <h2 id=create-mongo-database>Create Mongo Database<a class=headerlink href=#create-mongo-database title="Permanent link">&para;</a></h2> <p>Now that we have an <strong>Account</strong> that manages a <strong>MongoDB</strong> instance, we can create a MongoDB <strong>Database</strong> in the Account.</p> <div class=highlight><span class=filename>database.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: cosmosdb.azure.upbound.io/v1beta1</span>
<span class=s2>kind: MongoDatabase</span>
<span class=s2>metadata:</span>
<span class=s2>  annotations:</span>
<span class=s2>    meta.upbound.io/example-id: cosmosdb/v1beta1/mongocollection</span>
<span class=s2>  labels:</span>
<span class=s2>    testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  forProvider:</span>
<span class=s2>    accountNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>    resourceGroupNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>database.yml
</code></pre></div> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>database.yml
</code></pre></div> <h2 id=create-mongo-collection>Create Mongo Collection<a class=headerlink href=#create-mongo-collection title="Permanent link">&para;</a></h2> <p>In the MongoDB <strong>Database</strong>, we want to have at least one <strong>Collection</strong> (<a href=https://www.mongodb.com/docs/manual/core/databases-and-collections/ >read more about Database and Collection</a>).</p> <p>All the same rules as before apply. We define the resource's properties and then reference the dependencies.</p> <div class=highlight><span class=filename>collection.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: cosmosdb.azure.upbound.io/v1beta1</span>
<span class=s2>kind: MongoCollection</span>
<span class=s2>metadata:</span>
<span class=s2>  annotations:</span>
<span class=s2>    meta.upbound.io/example-id: cosmosdb/v1beta1/mongocollection</span>
<span class=s2>  labels:</span>
<span class=s2>    testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  forProvider:</span>
<span class=s2>    defaultTtlSeconds: 777</span>
<span class=s2>    index:</span>
<span class=s2>    - keys:</span>
<span class=s2>      - _id</span>
<span class=s2>      unique: true</span>
<span class=s2>    shardKey: uniqueKey</span>
<span class=s2>    throughput: 400</span>
<span class=s2>    accountNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>    databaseNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>    resourceGroupNameSelector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        testing.upbound.io/example-name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>collection.yml
</code></pre></div> <p>And as always, we apply the resource to the cluster and let Crossplane work its magic.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>collection.yml
</code></pre></div> <h2 id=verify-managed-resource-creation>Verify Managed Resource Creation<a class=headerlink href=#verify-managed-resource-creation title="Permanent link">&para;</a></h2> <p>Create the Crossplane resources and then verify the resources have a successful reconciliation.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>resourcegroup,mongocollection,mongodatabase,account<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--namespace<span class=w> </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
</code></pre></div> <p>This should yield something like this: (where <code>trp-cosmosdb-mongo-01</code> will be your <code>$UNIQUE_NAME</code>)</p> <div class=highlight><pre><span></span><code>NAME<span class=w>                                                            </span>READY<span class=w>   </span>SYNCED<span class=w>   </span>EXTERNAL-NAME<span class=w>           </span>AGE
resourcegroup.azure.upbound.io/trp-cosmosdb-mongo-01<span class=w>            </span>True<span class=w>    </span>True<span class=w>     </span>trp-cosmosdb-mongo-01<span class=w>   </span>26h

NAME<span class=w>                                                            </span>READY<span class=w>   </span>SYNCED<span class=w>   </span>EXTERNAL-NAME<span class=w>           </span>AGE
mongocollection.cosmosdb.azure.upbound.io/trp-cosmosdb-mongo-01<span class=w> </span>True<span class=w>    </span>True<span class=w>     </span>trp-cosmosdb-mongo-01<span class=w>   </span>26h

NAME<span class=w>                                                            </span>READY<span class=w>   </span>SYNCED<span class=w>   </span>EXTERNAL-NAME<span class=w>           </span>AGE
mongodatabase.cosmosdb.azure.upbound.io/trp-cosmosdb-mongo-01<span class=w>   </span>True<span class=w>    </span>True<span class=w>     </span>trp-cosmosdb-mongo-01<span class=w>   </span>26h

NAME<span class=w>                                                            </span>READY<span class=w>   </span>SYNCED<span class=w>   </span>EXTERNAL-NAME<span class=w>           </span>AGE
account.cosmosdb.azure.upbound.io/trp-cosmosdb-mongo-01<span class=w>         </span>True<span class=w>    </span>True<span class=w>     </span>trp-cosmosdb-mongo-01<span class=w>   </span>26h
</code></pre></div> <p>To use the <strong>MongoDB</strong> instance from our application, we need to bind the connection details.</p> <p>The secret generated by Crossplane via the <code>writeConnectionSecretToRef</code> does not use the expected syntax. So we use the SecretGen controller with a <code>SecretTemplate</code> to generate a secret that does.</p> <h2 id=create-a-connection-details-secret>Create a connection details secret<a class=headerlink href=#create-a-connection-details-secret title="Permanent link">&para;</a></h2> <p>The Services Toolkit needs a Kubernetes Secret with a format that adheres to the <a href=https://servicebinding.io/ >Service Binding</a> specification.</p> <p>Unfortunately, the secret that the <strong>Account</strong> manage resource generates does not conform. We use a <strong>SecretTemplate</strong> that maps the <strong>Account</strong> secret to a secret usable by the automatic binding.</p> <h3 id=secretgen-rbac-permissions>SecretGen RBAC permissions<a class=headerlink href=#secretgen-rbac-permissions title="Permanent link">&para;</a></h3> <p>The <strong>SecretGen Controller</strong> needs permissions in the secret's namespace. So we create a <code>ServiceAccount</code> with the appropriate permissions and then the <code>SecretTemplate</code>.</p> <div class=highlight><span class=filename>secretgen-rbac.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: v1</span>
<span class=s2>kind: ServiceAccount</span>
<span class=s2>metadata:</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>---</span>
<span class=s2>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s2>kind: Role</span>
<span class=s2>metadata:</span>
<span class=s2>  name: secret-gen-reader</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>rules:</span>
<span class=s2>- apiGroups:</span>
<span class=s2>  - \&quot;\&quot;</span>
<span class=s2>  resources:</span>
<span class=s2>  - secrets</span>
<span class=s2>  verbs:</span>
<span class=s2>  - get</span>
<span class=s2>  - list</span>
<span class=s2>  - watch</span>
<span class=s2>  resourceNames:</span>
<span class=s2>  - </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>---</span>
<span class=s2>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s2>kind: RoleBinding</span>
<span class=s2>metadata:</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span><span class=s2>-role-binding</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>roleRef:</span>
<span class=s2>  apiGroup: rbac.authorization.k8s.io</span>
<span class=s2>  kind: Role</span>
<span class=s2>  name: secret-gen-reader</span>
<span class=s2>subjects:</span>
<span class=s2>- kind: ServiceAccount</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>secretgen-rbac.yml
</code></pre></div> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>secretgen-rbac.yml
</code></pre></div> <h3 id=secret-template>Secret Template<a class=headerlink href=#secret-template title="Permanent link">&para;</a></h3> <p>And then we can create a <strong>SecretTemplate</strong> that transforms the secret from the Crossplane <strong>Account</strong> to a secret that the Services Toolkit can bind.</p> <div class=highlight><span class=filename>secret-template.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: secretgen.carvel.dev/v1alpha1</span>
<span class=s2>kind: SecretTemplate</span>
<span class=s2>metadata:</span>
<span class=s2>  name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span><span class=s2>-bindable</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  serviceAccountName: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  inputResources:</span>
<span class=s2>  - name: creds</span>
<span class=s2>    ref:</span>
<span class=s2>      apiVersion: v1</span>
<span class=s2>      kind: Secret     </span>
<span class=s2>      name: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>  template:</span>
<span class=s2>    metadata:</span>
<span class=s2>      labels:</span>
<span class=s2>        app.kubernetes.io/component: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>        app.kubernetes.io/instance: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>        services.apps.tanzu.vmware.com/class: azure-mongodb</span>
<span class=s2>    type: mongodb</span>
<span class=s2>    stringData:</span>
<span class=s2>      type: mongodb</span>
<span class=s2>      database: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>    data:</span>
<span class=s2>      uri: &#39;\$(.creds.data.attribute\\.connection_strings\\.0)&#39;</span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>secret-template.yml
</code></pre></div> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>secret-template.yml
</code></pre></div> <div class="admonition warning"> <p class=admonition-title>Resource Claim Policy</p> <p>If we create our Claim in one namespace and the claimable resource in another, we need a <strong>ResourceClaimPolicy</strong>.</p> <p>See below how to create one!</p> </div> <p>We verify the SecretTemplate's secret exists by running the following command:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>secret<span class=w> </span>-n<span class=w> </span><span class=nv>$UNIQUE_NAME</span>
</code></pre></div> <p>This should give you two secrets: (where <code>trp-mongodb-docs-test</code> will be your <code>$UNIQUE_NAME</code>)</p> <div class=highlight><pre><span></span><code>NAME<span class=w>                             </span>TYPE<span class=w>                                </span>DATA<span class=w>   </span>AGE
trp-mongodb-docs-test<span class=w>            </span>connection.crossplane.io/v1alpha1<span class=w>   </span><span class=m>8</span><span class=w>      </span>24m
trp-mongodb-docs-test-bindable<span class=w>   </span>mongodb<span class=w>                             </span><span class=m>3</span><span class=w>      </span>94s
</code></pre></div> <h2 id=resourceclaim-policy-optional>ResourceClaim Policy (optional)<a class=headerlink href=#resourceclaim-policy-optional title="Permanent link">&para;</a></h2> <p>We determine the Developer namespace configured in the Tanzu Application Platform (TAP) installation. If in doubt, assume it is <code>default</code>.</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>TAP_DEV_NAMESPACE</span><span class=o>=</span>default
</code></pre></div> <p>Then you create a <strong>ResourceClaimPolicy</strong> ensuring applications deployed in TAP can use the Service Toolkit claim.</p> <div class=highlight><span class=filename>resource-claim-policy.yml</span><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;apiVersion: services.apps.tanzu.vmware.com/v1alpha1</span>
<span class=s2>kind: ResourceClaimPolicy</span>
<span class=s2>metadata:</span>
<span class=s2>  name: default-can-claim-azure-mongodb</span>
<span class=s2>  namespace: </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
<span class=s2>spec:</span>
<span class=s2>  subject:</span>
<span class=s2>    kind: Secret</span>
<span class=s2>    group: \&quot;\&quot;</span>
<span class=s2>    selector:</span>
<span class=s2>      matchLabels:</span>
<span class=s2>        services.apps.tanzu.vmware.com/class: azure-mongodb</span>
<span class=s2>  consumingNamespaces: [ \&quot;</span><span class=si>${</span><span class=nv>TAP_DEV_NAMESPACE</span><span class=si>}</span><span class=s2>\&quot; ] </span>
<span class=s2>&quot;</span><span class=w> </span>&gt;<span class=w> </span>resource-claim-policy.yml
</code></pre></div> <p>Verify the status of the <strong>ResourceClaimPolicy</strong>:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>resource-claim-policy.yml<span class=w> </span>-n<span class=w> </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span>
</code></pre></div> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">&para;</a></h2> <div class="admonition success"> <p class=admonition-title>Success</p> <p>You can return to the <a href=../#once-resources-are-ready>main guide<span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7Z"/></svg></span></a> to continue with the Services Toolkit sections.</p> <p>You should come back for the cleanup commands; see below.</p> </div> <h2 id=cleanup>Cleanup<a class=headerlink href=#cleanup title="Permanent link">&para;</a></h2> <div class="admonition danger"> <p class=admonition-title>Danger</p> <p>These commands delete the resources in Azure.</p> <p>Crossplane uses finalizers on its resources. This ensures that the <code>kubectl delete</code> blocks until it confirms the resources are removed at the provider level.</p> </div> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>resource-claim-policy.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>secret-template.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>collection.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>database.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>account.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>resourcegroup.yml<span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
kubectl<span class=w> </span>delete<span class=w> </span>namespace<span class=w> </span><span class=si>${</span><span class=nv>UNIQUE_NAME</span><span class=si>}</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>true</span>
</code></pre></div> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>If you are done with this Crossplane Provider, or want to try out the Crossplane package solution, you have to delete the <strong>Provider</strong> and <strong>ProviderConfig</strong> resources as well.</p> </div> <div class="admonition info"> <p class=admonition-title>Info</p> <p><strong>ProviderConfig</strong> resources are owned by the <strong>Provider</strong> installed at the time. So installing the Azure Provider again via a package dependency, for example, would be blocked because the <strong>ProviderConfig</strong> is owned by the previous <strong>Provider</strong> installation.</p> <p>Resources, such as the MongoDB Database, using the <strong>ProviderConfig</strong> block its deletion.</p> <p>A <strong>ProviderConfig</strong> resource belongs to the <strong>Provider</strong> and has a unique <em>Group</em>. So to avoid possible conflicts with other <strong>ProviderConfigs</strong>, we delete it via its full name.</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>delete<span class=w> </span>providerconfigs.azure.upbound.io<span class=w> </span>default
kubectl<span class=w> </span>delete<span class=w> </span>providers.pkg.crossplane.io<span class=w> </span>upbound-provider-azure
</code></pre></div> </div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2022-11-18 09:51:36</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 VMware </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../../../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"method": "mike", "provider": "mike"}}</script> <script src=../../../../../../assets/javascripts/bundle.6df46069.min.js></script> </body> </html>